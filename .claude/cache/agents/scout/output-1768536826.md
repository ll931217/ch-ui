# Codebase Report: Permission Management Interface
Generated: 2026-01-16

## Summary

The CH-UI application has a user management system with basic permission controls. The current implementation uses a **checkbox-based** permission selector in the CreateUser workflow. Permission grants are applied at the **database level**, with specific privileges (SELECT, INSERT, DDL, etc.) granted per database.

## Project Structure

```
src/features/admin/
  ├── components/
  │   ├── CreateUser/
  │   │   ├── index.tsx                    # Main user creation orchestrator
  │   │   ├── PrivilegesSection.tsx        # Permission checkboxes
  │   │   ├── DatabaseRolesSection.tsx     # Database selection
  │   │   ├── AccessControlSection.tsx     # Host/validity controls
  │   │   ├── AuthenticationSection.tsx    # Password/auth
  │   │   └── SettingsSection.tsx          # User settings
  │   └── UserManagement/
  │       ├── index.tsx                    # User list/management
  │       └── UsersTable.tsx               # Display users with grants
  ├── routes/
  │   └── adminRoute.tsx                   # Admin access control
  └── types.ts                             # UserData interface
```

## 1. Permission Management UI Location

### Main Component
**File:** `/src/features/admin/components/CreateUser/index.tsx`

**Entry Point:** `CreateNewUser` component
- Orchestrates the entire user creation workflow
- Contains form state management with `react-hook-form`
- Handles submission and SQL generation

### Permission Section
**File:** `/src/features/admin/components/CreateUser/PrivilegesSection.tsx`

**Component:** `PrivilegesSection`
- Renders permission checkboxes
- Shows/hides granular permissions based on admin toggle
- Uses shadcn/ui `Card`, `Checkbox`, and `Form` components

## 2. Supported Permissions

### Current Permission Types

From `PrivilegesSection.tsx` and `buildGrantQueries()` function:

| Permission | SQL Privilege | Description |
|------------|---------------|-------------|
| **isAdmin** | `ALL ON *.* WITH GRANT OPTION` | Full admin access to all databases |
| **allowSelect** | `SELECT` | Read data from tables |
| **allowInsert** | `INSERT` | Insert data into tables |
| **allowDDL** | `CREATE, DROP, ALTER, CREATE DATABASE` | Schema modification |
| **allowAlter** | `ALTER` | Modify table structure |
| **allowCreate** | `CREATE` | Create new objects |
| **allowDrop** | `DROP` | Delete objects |
| **allowTruncate** | `TRUNCATE` | Clear table data |

### Permission Hierarchy

```
Admin (isAdmin = true)
└── GRANT ALL ON *.* WITH GRANT OPTION
    └── Skips database-specific grants

Non-Admin
├── Database Selection Required (grantDatabases[])
└── Per-Database Grants
    ├── SELECT
    ├── INSERT
    ├── ALTER
    ├── CREATE
    ├── DROP
    ├── TRUNCATE
    └── DDL (expanded to CREATE, DROP, ALTER, CREATE DATABASE)
```

## 3. Data Models & Types

### TypeScript Interface

**File:** `/src/features/admin/types.ts`

```typescript
export interface UserData {
  name: string;
  id: string;
  auth_type: string[];
  host_ip?: string[];
  host_names?: string[];
  host_names_regexp?: string[];
  host_names_like?: string[];
  default_roles_all: number;
  default_roles_list?: string[];
  default_database?: string;
  grantees_any: number;        // Can grant to others
  grantees_list?: string[];
  grants?: any[];               // SHOW GRANTS results
  settings_profile?: string;
  readonly?: boolean;
}
```

### Form Schema

**File:** `/src/features/admin/components/CreateUser/index.tsx`

```typescript
defaultValues: {
  username: "",
  password: "",
  hostType: "ANY",
  hostValue: "",
  validUntil: undefined,
  defaultRole: "",
  defaultDatabase: "",
  grantDatabases: [],           // Array of database names
  grantees: "NONE",
  settings: {
    profile: "",
    readonly: false,
  },
  privileges: {
    isAdmin: false,
    allowDDL: false,
    allowInsert: false,
    allowSelect: false,
    allowAlter: false,
    allowCreate: false,
    allowDrop: false,
    allowTruncate: false,
  },
}
```

## 4. GRANT/REVOKE Operations

### Grant Implementation

**File:** `/src/features/admin/components/CreateUser/index.tsx`

**Function:** `buildGrantQueries(username: string, data: any)`

#### Logic Flow

```typescript
if (data.privileges.isAdmin) {
  return [`GRANT ALL ON *.* TO ${username} WITH GRANT OPTION`];
}

// For each selected database
for (const db of data.grantDatabases) {
  const privileges = [];
  
  // Collect individual permissions
  if (allowSelect) privileges.push("SELECT");
  if (allowInsert) privileges.push("INSERT");
  if (allowAlter) privileges.push("ALTER");
  if (allowCreate) privileges.push("CREATE");
  if (allowDrop) privileges.push("DROP");
  if (allowTruncate) privileges.push("TRUNCATE");
  
  // Generate grant query
  queries.push(`GRANT ${privileges.join(", ")} ON ${db}.* TO ${username}`);
  
  // DDL grants separately
  if (allowDDL) {
    queries.push(`GRANT CREATE, DROP, ALTER, CREATE DATABASE ON ${db}.* TO ${username}`);
  }
}
```

### Example Generated SQL

**Scenario:** User with SELECT + INSERT on `my_database`

```sql
CREATE USER IF NOT EXISTS john IDENTIFIED WITH sha256_password BY 'pass123' GRANTEES NONE;
GRANT SELECT, INSERT ON my_database.* TO john;
```

**Scenario:** Admin user

```sql
CREATE USER IF NOT EXISTS admin_user IDENTIFIED WITH sha256_password BY 'secure' GRANTEES NONE;
GRANT ALL ON *.* TO admin_user WITH GRANT OPTION;
```

### REVOKE Operations

**File:** `/src/features/admin/components/UserManagement/index.tsx`

Currently **NO EXPLICIT REVOKE UI** exists. Permissions are only managed at user creation time.

**Existing operations:**
- `DROP USER` - Delete entire user
- No UI for modifying existing user permissions

## 5. Current UI Pattern for Permission Selection

### Component: PrivilegesSection

**Pattern:** Flat checkbox list with conditional rendering

```tsx
<Card>
  <Checkbox> Admin Privileges </Checkbox>
  
  {!isAdmin && (
    <>
      <Checkbox> Select Permission </Checkbox>
      <Checkbox> Insert Permission </Checkbox>
      <Checkbox> DDL Permission </Checkbox>
      {/* ... more checkboxes */}
    </>
  )}
</Card>
```

### UI Components Used

| Component | Purpose | File |
|-----------|---------|------|
| `Card` | Section container | `@/components/ui/card` |
| `Checkbox` | Boolean permission toggle | `@/components/ui/checkbox` |
| `FormField` | Form integration | `@/components/ui/form` |
| `FormLabel` | Permission label | `@/components/ui/form` |
| `FormDescription` | Helper text | `@/components/ui/form` |

### Database Selection Pattern

**Component:** `DatabaseRolesSection`

**Pattern:** Multi-select dropdown with badge display

```tsx
<Select onValueChange={addDatabase}>
  {databases.map(db => <SelectItem value={db}>{db}</SelectItem>)}
</Select>

<div className="flex flex-wrap gap-2">
  {grantDatabases.map(db => (
    <Badge onClick={removeDatabase}>
      {db} <X />
    </Badge>
  ))}
</div>
```

## 6. API Endpoints / Query Structure

### Database Queries Used

#### Fetch Available Databases
```sql
-- From useMetadata hook
SHOW DATABASES
```

#### Create User
```sql
CREATE USER IF NOT EXISTS {username} 
  [ON CLUSTER {cluster}]
  IDENTIFIED WITH sha256_password BY '{password}' 
  [HOST {type} '{value}']
  [VALID UNTIL '{date}']
  [DEFAULT ROLE {role}]
  [DEFAULT DATABASE {db}]
  GRANTEES {NONE|ANY}
  [SETTINGS PROFILE '{profile}']
  [SETTINGS READONLY=1]
```

#### Grant Privileges
```sql
GRANT {privileges} ON {database}.* TO {username}
```

#### Fetch User Grants
```sql
-- From UserManagement/index.tsx
SHOW GRANTS FOR {username}
```

#### Check Admin Status
```sql
-- From store/index.ts
SELECT if(grant_option = 1, true, false) AS is_admin
FROM system.grants
WHERE user_name = currentUser()
LIMIT 1
```

## 7. Existing Tree/Hierarchical Components

### TreeNode Component

**File:** `/src/features/explorer/components/TreeNode.tsx`

**Purpose:** Database/table explorer tree

**Key Features:**
- Expandable/collapsible nodes with chevron icons
- Recursive rendering for nested structures
- Context menu support
- Search filtering
- Icon-based type identification

**Data Structure:**
```typescript
interface TreeNodeData {
  name: string;
  type: "database" | "table" | "view" | "saved_query";
  children?: TreeNodeData[];
  query?: string;
}
```

**UI Pattern:**
```tsx
<div onClick={toggleOpen}>
  {hasChildren && (isOpen ? <ChevronDown /> : <ChevronRight />)}
  {getIcon(node.type)}
  {node.name}
</div>

{isOpen && node.children?.map(child => 
  <TreeNode node={child} level={level + 1} />
)}
```

### Available UI Components for Trees

| Component | Path | Use Case |
|-----------|------|----------|
| `Accordion` | `@/components/ui/accordion` | Collapsible sections |
| `ContextMenu` | `@/components/ui/context-menu` | Right-click actions |
| `DropdownMenu` | `@/components/ui/dropdown-menu` | Action menus |
| `Checkbox` | `@/components/ui/checkbox` | Selection |
| `Badge` | `@/components/ui/badge` | Tags/labels |
| `ScrollArea` | `@/components/ui/scroll-area` | Scrollable containers |

## Key Files Summary

| File | Purpose | Key Exports/Functions |
|------|---------|----------------------|
| `admin/components/CreateUser/index.tsx` | Main user creation | `CreateNewUser`, `buildGrantQueries`, `buildUserCreationQuery` |
| `admin/components/CreateUser/PrivilegesSection.tsx` | Permission UI | `PrivilegesSection` |
| `admin/components/CreateUser/DatabaseRolesSection.tsx` | Database selection | `DatabaseRolesSection` |
| `admin/components/UserManagement/index.tsx` | User list | `UserTable`, `fetchUserGrants` |
| `admin/types.ts` | Type definitions | `UserData` |
| `explorer/components/TreeNode.tsx` | Tree UI pattern | `TreeNode`, `TreeNodeData` |
| `store/index.ts` | State management | `runQuery`, `isAdmin` |

## Conventions Discovered

### Naming
- Files: PascalCase for components (`PrivilegesSection.tsx`)
- Functions: camelCase (`buildGrantQueries`)
- Types: PascalCase with suffix (`CreateNewUserProps`)

### Patterns
| Pattern | Usage | Example |
|---------|-------|---------|
| Section Components | Modular form sections | `AuthenticationSection`, `PrivilegesSection` |
| Shadcn/UI | UI component library | `Card`, `Button`, `Checkbox` |
| React Hook Form | Form management | `useForm()`, `FormField` |
| Zustand Store | Global state | `useAppStore()` |
| Toast Notifications | User feedback | `toast.success()`, `toast.error()` |

### Form Structure
- Each section in its own component
- Props: `{ form }` passed from parent
- `form.watch()` for reactive form values
- `form.setValue()` for programmatic updates

### SQL Generation
- String concatenation for query building
- Conditional clauses based on form data
- Separate functions for CREATE and GRANT queries
- Error handling with try/catch and toast

## Architecture Map

```
[CreateNewUser (Parent Form)]
        |
        ├── AuthenticationSection (username, password)
        ├── AccessControlSection (host restrictions)
        ├── DatabaseRolesSection (database selection)
        ├── PrivilegesSection (permission checkboxes) ← TARGET FOR ENHANCEMENT
        └── SettingsSection (profiles, readonly)
                |
                v
        buildUserCreationQuery()
        buildGrantQueries()
                |
                v
        runQuery() → ClickHouse API
                |
                v
        UserManagement (display results)
```

## Open Questions / Enhancement Opportunities

1. **No REVOKE/Modify UI** - Users can only be created or deleted, not modified
2. **Flat Permission List** - All permissions shown as flat checkboxes
3. **No Table-Level Grants** - Permissions are database-wide only
4. **No Role Management** - Roles can be assigned but not created/managed in UI
5. **No Visual Hierarchy** - Parent/child permission relationships not visible
6. **No Permission Templates** - Common permission sets must be selected manually each time

## Recommended Enhancement: Hierarchical Permission Tree

### Proposed Structure

```
[✓] Database: analytics
    ├── [✓] SELECT (all tables)
    ├── [ ] INSERT (all tables)
    └── Tables
        ├── [✓] users
        │   ├── [✓] SELECT
        │   └── [ ] INSERT
        └── [ ] orders

[ALL] - Grant all privileges
  ├── [DDL] - Schema modification
  │   ├── CREATE
  │   ├── DROP
  │   └── ALTER
  ├── [DML] - Data modification
  │   ├── SELECT
  │   ├── INSERT
  │   ├── UPDATE
  │   └── DELETE
  └── [ADMIN] - Administrative
      ├── GRANT OPTION
      └── ROLE ADMIN
```

### Implementation Components Needed

1. **PermissionTreeNode** - Recursive tree component based on TreeNode pattern
2. **PermissionNode interface** - Data structure for hierarchical permissions
3. **buildTreeGrantQueries()** - Generate GRANT statements from tree selections
4. **Permission presets** - Common permission templates (read-only, read-write, admin)

